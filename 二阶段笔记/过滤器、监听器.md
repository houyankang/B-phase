

# 过滤器、监听器

### 一、过滤器

#### 1.1过滤器的概念

> * 概念
>   * 过滤器就是一个用于在请求之前处理资源的组件
> * 生命周期
>   * 随着服务器启动而初始化
>   * 随着请求的发出而过滤
>   * 随着服务器关闭而销毁
> * 执行流程
>   * 浏览器发起请求
>   * 服务器会根据这个请求，创建request对象及response对象
>   * 过滤器会持有request对象及response对象
>   * 只有当过滤器放行之后，request对象及response对象才会传给Serlvet
> * 过滤器链
>   * 根据配置顺序，遵从"先过滤，后放行"的原则!

#### 1.2.过滤器的基本使用

> 开发步骤
>
> * 自定义类实现Filter接口
> * 重写init、doFilter、destroy方法
> * 在web.xml中配置过滤器
>   * 声明过滤器
>   * 过滤器配置过滤路径

- 代码实现

  - 过滤器

  ```java
  public class Demo01Filter implements Filter {
      @Override
      public void init(FilterConfig filterConfig) throws ServletException {
          //Demo01Filter过滤器的初始化
          System.out.println("Demo01Filter初始化");
      }
  
      @Override
      public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
          //Demo01Filter过滤器处理请求
          System.out.println("Demo01Filter放行之前");
          filterChain.doFilter(servletRequest,servletResponse);
          System.out.println("Demo01Filter放行之后");
      }
  
      @Override
      public void destroy() {
          //Demo01Filter过滤器的销毁
          System.out.println("Demo01Filter销毁");
      }
  }
  ```

  - web.xml

  ```xml
  <!--声明Demo01Filter过滤器-->
  <filter>
      <filter-name>Demo01Filter</filter-name>
      <filter-class>com.qfedu.filter.Demo01Filter</filter-class>
  </filter>
  
  <!--配置Demo01Filter的过滤路径-->
  <filter-mapping>
      <filter-name>Demo01Filter</filter-name>
      <url-pattern>/*</url-pattern>
  </filter-mapping>
  ```

#### 1.3.过滤器的相关配置

初始化参数

##### 1.3.1Filter配置初始化参数

```xml
    <filter>
        <filter-name>Demo03Filter</filter-name>
        <filter-class>com.qfedu.filter.Demo03Filter</filter-class>
        <!--初始化参数-->
        <init-param>
            <param-name>username</param-name>
            <param-value>root</param-value>
        </init-param>
        <init-param>
            <param-name>password</param-name>
            <param-value>root123</param-value>
        </init-param>

    </filter>
```

##### 1.3.2Filter获取初始化参数

```java
public class Demo03Filter implements Filter {

    public void init(FilterConfig config) throws ServletException {
        Enumeration<String> parameterNames = config.getInitParameterNames();
        while (parameterNames.hasMoreElements()) {
            //获取初始化参数名称
            String parameterName = parameterNames.nextElement();
            //获取初始化参数值
            String parameterValue = config.getInitParameter(parameterName);
            System.out.println("name : " + parameterName + " , value : " + parameterValue);
        }
    }
    
    ......
    
}
```

##### 1.3.3Filter的过滤路径

> - 针对<servlet-name> ，以为Filter仅针对Demo01Servlet进行过滤
>
> ```java
> <filter-mapping>
>     <filter-name>Demo03Filter</filter-name>
>     <servlet-name>Demo01Servlet</servlet-name>
> </filter-mapping>
> ```
>
> - 针对<url-pattern>
>
>   - 完全匹配：必须以"/"开头
>
>   ```xml
>   <filter-mapping>
>       <filter-name>Demo03Filter</filter-name>
>       <url-pattern>/aa</url-pattern>
>   </filter-mapping>
>   ```
>
>   ​	[过滤器只过滤访问路径完全匹配"/aa"的资源]()
>
>   - 目录匹配:必须以"/"开头，以"*"结尾
>
>   ```xml
>   <filter-mapping>
>       <filter-name>Demo03Filter</filter-name>
>       <url-pattern>/aa/bb/*</url-pattern>
>   </filter-mapping>
>   ```
>
>   ​	[过滤器只过滤访问路径目录匹配到“/aa/bb“的资源]()
>
>   - 后缀名匹配:必须以"*"开头，以后缀名结尾
>
>   ```xml
>   <filter-mapping>
>       <filter-name>Demo03Filter</filter-name>
>       <url-pattern>*.jsp</url-pattern>
>   </filter-mapping>
>   ```
>
>   ​	[过滤器只过滤后缀名为jsp的资源]()

#### 1.4.相关案例

##### 1.4.1过滤器案例之中文乱码

> 开发步骤
>
> * 自定义过滤器
> * 完成请求参数中文乱码解决

- web.xml

```xml

    <filter>
        <filter-name>EncodingFilter</filter-name>
        <filter-class>filter.EncodingFilter</filter-class>
        <init-param>
            <param-name>encoding</param-name>
            <param-value>utf-8</param-value>
        </init-param>
    </filter>
    <filter-mapping>
        <filter-name>EncodingFilter</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>
```

- EncodingFilter

```java
public class EncodingFilter implements Filter {
    private String encoding = null;
    public void destroy() {
    }
    public void init(FilterConfig config) throws ServletException {
        //获取xml中encoding的参数值：utf-8
        encoding = config.getInitParameter("encoding");
    }

    public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain) throws ServletException, IOException {
        resp.setContentType("text/html;charset="+encoding);
        req.setCharacterEncoding(encoding);
        chain.doFilter(req, resp);
    }

}

```

##### 1.4.2过滤器案例之自动登录

> 开发步骤
>
> * 登录功能
>   * 登录成功，将账户和密码存储到cookie中，跳转到首页
>   * 登录失败，转发到登录页面
> * 自动登录
>   * 判断访问的资源是否和登录相关
>   * 如果是登录相关资源，直接放行
>   * 如果不是登录相关资源 ，进行自动登录
>     * 判断登录状态
>       * 如果已经在登录状态，直接放行
>       * 如果不在登录状态，进行自动登录
>         * 获取cookie
>           * cookie为null（清理了浏览器缓存），转发到登录页面
>           * cookie不为null，进行自动登录
>             * 自动登录成功，修改登录状态，直接放行
>             * 自动登录失败（修改账户密码），转发到登录页面

- web.xml

```xml
<filter>
        <filter-name>AutoLoginFilter</filter-name>
        <filter-class>filter.AutoLoginFilter</filter-class>
    </filter>
    <filter-mapping>
        <filter-name>AutoLoginFilter</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>
```

- login.jsp

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
  <head>
    <title>登录</title>
  </head>
  <body>
  <form action="/day58/login" method="post">
    账号：<input type="text" name="username"><br>
    密码：<input type="text" name="password"><br>
    7天内自动登录：<input type="checkbox" name="autoLogin" value="autoLogin"><br>
    <button type="submit">登录</button>
  </form>

  </body>
</html>
```

- 获取Cookie的工具类CookieUtil

```java
public class CookieUtil {
    public static Cookie getCookie(Cookie[] cookies,String cookieName){
        for (Cookie cookie : cookies) {
            if(cookieName.equals(cookie.getName())){
                return cookie;
            }
        }
        return null;
    }
}

```

- 登录界面LoginServlet

```java
@WebServlet(name = "LoginServlet",urlPatterns = "/login")
public class LoginServlet extends HttpServlet {
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        //获取参数值
        String username = request.getParameter("username");
        String password = request.getParameter("password");
        //判断账户和密码是否都为root
        if("root".equals(username) && "root".equals(password)){
            //登录成功后，才可进行自动登录，自动登录，就是将用户信息保存起来
            //获取autoLogin的参数值(判断是否进行自动登录)
            String autoLogin = request.getParameter("autoLogin");
            System.out.println(autoLogin);
            if("autoLogin".equals(autoLogin)){
                Cookie cookie = new Cookie("autoLogin",username +"-"+ password);
                //设置cookie存储时间(存活时间)
                cookie.setMaxAge(7 * 24 * 60 * 60);
                response.addCookie(cookie);
            }

            //都为root登陆成功，将信息存入session，转发到一个页面，用来展示用户信息
            User existUser = new User();
            existUser.setUsername(username);
            existUser.setPassword(password);
            request.getSession().setAttribute("existUser",existUser);
            request.getRequestDispatcher("/showIndex").forward(request,response);

        }else {
            //没有登陆成功，转发到登录界面
            request.getRequestDispatcher("/login.jsp").forward(request,response);
        }
    }

    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doPost(request, response);
    }
}
```

- 展示界面ShowIndexServlet

```java
@WebServlet(name = "ShowIndexServlet",urlPatterns = "/showIndex")
public class ShowIndexServlet extends HttpServlet {
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        //取出session中的数据
        User existUser = (User) request.getSession().getAttribute("existUser");
        StringBuffer stringBuffer = new StringBuffer();
        //是否在登录状态
        if(existUser == null){
            //不在登录状态，转发到登录界面
            stringBuffer.append("您没有登录，<a href='/day58/login.jsp'>请登录</a>");

        }else {
            //在登录状态，展示
            stringBuffer.append("欢迎回来："+ existUser.getUsername());
        }
        response.getWriter().write(stringBuffer.toString());
    }

    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doPost(request, response);
    }
}
```

- 过滤操作AutoLoginFilter

```java
public class AutoLoginFilter implements Filter {
    public void destroy() {
    }

    public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain) throws ServletException, IOException {
        //获取HttpServlet
        HttpServletRequest request = (HttpServletRequest) req;
        //获取请求路径，并判断路径中是否包含登录相关
        String requestURI = request.getRequestURI();
        if(requestURI.contains("login")){
            //和登录资源相关，直接放行
            chain.doFilter(request, resp);
        }else {
            //不是登录相关的资源
            //判断是否在登录状态
            User existUser = (User) request.getSession().getAttribute("existUser");
            if(existUser == null){
                //不在登录状态，进行自动登录
                //利用Cookie工具类获取cookie
                Cookie cookie = CookieUtil.getCookie(request.getCookies(), "autoLogin");
                //判断cookie是否为空 , 存在浏览器清理缓存
                if(cookie == null){
                    //浏览器清理缓存 , 相当于自动登录失败!! 跳转到登录页面，进行手动登录
                    request.getRequestDispatcher("/login.jsp").forward(request,resp);
                }else {
                    //还有缓存，进行自动登录
                    //通过cookie获取用户信息 root-root
                    String infoStr = cookie.getValue();
                    //将字符串进行拆分
                    String[] split = infoStr.split("-");
                    String username = split[0];
                    String password = split[1];
                    //判断账号密码是否符合
                    if(username.equals("root") && password.equals("root")){
                        //自动登录成功  ,修改登录状态,直接放行
                        existUser = new User();
                        existUser.setUsername(username);
                        existUser.setPassword(password);
                        request.getSession().setAttribute("existUser",existUser);
                        chain.doFilter(request,resp);
                    }else {
                        //自动登录失败 (可能修改了密码) ，跳转到登录页面，进行手动登
                        request.getRequestDispatcher("/login.jsp").forward(request,resp);
                    }

                }

            }else {
                //在登录状态，直接放行
                chain.doFilter(request,resp);
            }
        }


    }

    public void init(FilterConfig config) throws ServletException {

    }

}

```

##### 1.4.3过滤器案例之屏蔽敏感词

```java
@WebFilter(
        filterName = "SensitiveWordsFilter" ,
        urlPatterns = "/*",
        initParams = {
                @WebInitParam(name = "word1",value = "笨蛋"),
                @WebInitParam(name = "word2" ,value = "老邱"),
                @WebInitParam(name = "word3" ,value = "中邱"),
                @WebInitParam(name = "word4",value = "小邱")
        })
public class SensitiveWordsFilter implements Filter {

    //敏感词
    List<String> sensitiveWords = new ArrayList<>();

    public void init(FilterConfig config) throws ServletException {
        Enumeration<String> parameterNames = config.getInitParameterNames();
        while (parameterNames.hasMoreElements()) {
            String sensitiveWord = config.getInitParameter(parameterNames.nextElement());
            sensitiveWords.add(sensitiveWord);
        }
    }

    public void destroy() {
    }



    public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain) throws ServletException, IOException {
        System.out.println("SensitiveWordsFilter doFilter");
        HttpServletRequest request = (HttpServletRequest) req;
        //增强request下的getParameter方法
        HttpServletRequest requestPrxoy = (HttpServletRequest) Proxy.newProxyInstance(
                request.getClass().getClassLoader(),
                request.getClass().getInterfaces(),
                new InvocationHandler() {
                    @Override
                    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                        //增强getParameter方法
                        Object returnValue = null;
                        String methodName = method.getName();
                        if ("getParameter".equals(methodName)) {
                            //returnValue就是getParameter方法的返回值,可能会存在敏感词
                            String returnValue1 = (String)method.invoke(request, args);
                            //开始处理敏感词
                            for (String sensitiveWord : sensitiveWords) {
                                if (returnValue1.contains(sensitiveWord)) {
                                    //getParameter方法的返回值包含敏感词
                                    returnValue1 = returnValue1.replace(sensitiveWord,"***");
                                }
                            }
                            return returnValue1;
                        } else {
                            returnValue = method.invoke(request, args);
                        }
                        return returnValue;
                    }
                });
        chain.doFilter(requestPrxoy, resp);
    }



}
```



### 二、监听器

#### 2.1监听器的介绍

> * 监听器概念
>   * 事件源：事件发生的源头
>   * 监听器：监听事件发生
>   * 绑定：将监听器绑定到事件源
>   * 事件：能够触发监听器的事
>
> * Servlet监听器
>   * 事件源：request域对象、session域对象、ServletContext域对象
>   * 监听器：Servlet三种监听器
>   * 绑定：配置web.xml
>   * 事件：域对象发生改变

#### 2.2监听器的分类

> * 一类监听器
>   * 监听域对象的创建、销毁
> * 二类监听器
>   * 监听域对象中的属性变更(属性设置、属性替换、属性移除)
> * 三类监听器
>   * 监听域对象的java对象的绑定

#### 2.3一类监听器的基本使用

> * 一类监听器
>   * ServletRequestListener ： 监听ServletRequest域对象的创建、销毁
>   * HttpSessionListener ：监听HttpSession域对象的创建、销毁
>   * ServletContextListener ： 监听ServletContext域对象的创建、销毁
>
> * 开发步骤
>
>   * 自定义类实现一类监听器
>   * 重写监听器中的方法
>   * 配置web.xml

> 
>
> * 事件源： ServletContext域对象
> * 监听器：ServletContextListener
> * 绑定:  web.xml配置
> * 事件 : ServletContext域对象发生了创建、发生了销毁

- 代码实现

  - 监听器

  ```
  public class MyListener01 implements ServletContextListener {
  
      @Override
      public void contextInitialized(ServletContextEvent sce) {
          //监听ServletContext域的初始化,随着服务器的启动
          System.out.println("ServletContext初始化");
      }
  
      @Override
      public void contextDestroyed(ServletContextEvent sce) {
          //监听ServletContext域的销毁，随着服务器的关闭
          System.out.println("ServletContext销毁");
      }
  }
  ```

  - web.xml绑定

  ```xml
  <listener>
      <listener-class>com.qfedu.listener.MyListener01</listener-class>
  </listener>
  ```

  

#### 2.4二类监听器的基本使用

> 分类
>
> * ServletRequestAttributeListener
>   * 监听ServletRequest域对象中属性变更
> * HttpSessionAttributeListener
>   * 监听HttpSession域对象中属性变更
> * ServletContextAttributeListener
>   * 监听ServletContext域对象中属性变更

代码实现

- 监听器

```java
public class MyServletContextAttributeListener implements ServletContextAttributeListener {

    @Override
    public void attributeAdded(ServletContextAttributeEvent scae) {
        //监听ServletContext域对象中属性添加
        System.out.println("ServletContext added");
    }

    @Override
    public void attributeReplaced(ServletContextAttributeEvent scae) {
        //监听ServletContext域对象中属性值被替换
        System.out.println("ServletContext replaced");

    }

    @Override
    public void attributeRemoved(ServletContextAttributeEvent scae) {
        //监听ServletContext域对象中属性值移除
        System.out.println("ServletContext removed");

    }
}
```

- web.xml

```xml
<listener>
    <listener-class>com.qfedu.listener.MyServletContextAttributeListener</listener-class>
</listener>
```



#### 2.5三类监听器

> * HttpSessionBindingListener
>
>   * 监听session域中的java对象的状态(绑定和解绑)
>     * 绑定：将java对象存储到session域对象
>     * 解绑：将java对象从session域对象移除
>
> * 监听器组成
>
>   * 事件源：java对象
>   * 监听器：HttpSessionBindingListener
>   * 绑定：java对象实现HttpSessionBindingListener接口
>   * 事件：java对象在session中状态发生改变

- 代码实现

```java
public class User implements HttpSessionBindingListener {


    @Override
    public void valueBound(HttpSessionBindingEvent event) {
        System.out.println("User绑定");
    }

    @Override
    public void valueUnbound(HttpSessionBindingEvent event) {
        System.out.println("User解绑");
    }
    
    ......
    
}
```

[HttpSessionBindingListener监听不需要在web.xml配置]()

#### 2.6监听器应用之在线人数统计

> 开发步骤
>
> * 登录功能
>   * 登录失败，转发到登录页面
>   * 登录成功，记录登录状态，重定向到首页(显示用户名、注销登录、在线人数)
> * 注销登录
>   * 注销登录成功；正常来说，应该转发到登录页面；转发到首页
> * 在线人数
>   * 使用HttpSessionBindingListener监听器
>   * 使用ServletContext域对象，存储在线人数count

- 代码实现
  - 注销登录

  ```java
  @WebServlet(name = "LogoutServlet" ,urlPatterns = "/logout")
  public class LogoutServlet extends HttpServlet {
      protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
          //注销登录 ， 将existUser变量从session域中移除!
  //        request.getSession().removeAttribute("existUser");
          //注销登录，将session销毁 -> 将existUser变量从session域中移除!
          request.getSession().invalidate();
          //注销成功
         request.getRequestDispatcher("/showIndex").forward(request,response);
      }
  
      protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
          doPost(request, response);
      }
  }
  ```

  - 在线人数
    - 在同一个浏览器，操作多次登录，意味着是同一个session

    ```java
    public class User implements HttpSessionBindingListener {
    
    
        @Override
        public void valueBound(HttpSessionBindingEvent event) {
            //有人登录成功 , 在线人数(count)加1
            //判断是否是第一个登录成功的人
            //获取ServletContext
            ServletContext servletContext = event.getSession().getServletContext();
            Integer count = (Integer) servletContext.getAttribute("count");
            if (null == count) {
                //就是第一个登录成功的人
                count = 1;
            } else {
                //不是第一个登录成功的人
                count++;
            }
            servletContext.setAttribute("count",count);
        }
        //在同一个浏览器，操作多次登录，意味着是同一个session
        //第一次登录 ,session.setAttribute("existUser","root") , valueBound  +1
        //第二次登录 ,session.setAttribute("existUser","root1") , valueBound +1  -> valueUnbound -1
    
    
        @Override
        public void valueUnbound(HttpSessionBindingEvent event) {
            //有人注销登录 ，在线人数(count)减1
            System.out.println("User解绑");
            ServletContext servletContext = event.getSession().getServletContext();
            Integer count = (Integer) servletContext.getAttribute("count");
            count--;
            servletContext.setAttribute("count",count);
        }
    ```

    

### 三、JavaWeb综合案例

#### 3.1准备工作

- 代码实现

  - 登录页面

  ```html
  <!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <title>登录界面</title>
  </head>
  <body>
  <form action="/day60/login" method="post">
      账号：<input type="text" name="username"><br>
      密码：<input type="text" name="password"><br>
      <button type="submit">登录</button>
  </form>
  </body>
  </html>
  ```

  - JDBCUtil

  ```
  public class JDBCUtil {
      private static ComboPooledDataSource dataSource;
  
      static {
          dataSource = new ComboPooledDataSource();
      }
  
      public static ComboPooledDataSource getDataSource(){
          return dataSource;
      }
  }
  
  ```

  - UserDao

  ```java
  public interface UserDao {
      User login(User inputUser) throws Exception;
  
      List<User> selectUserList() throws Exception;
  
      void deleteById(Integer id) throws  Exception;
  
      void addUser(User inputUser) throws Exception;
  
      User selectUserById(Integer id) throws Exception;
  
      void updateUser(User user) throws  Exception;
  
      void deleteUsersByIds(List<Integer> idList) throws Exception;
  }
  ```

  - UserDaoImpl

  ```java
  public class UserDaoImpl implements UserDao {
      QueryRunner queryRunner = new QueryRunner(JDBCUtil.getDataSource());
      //登录界面，查询一个
      @Override
      public User login(User inputUser) throws Exception {
          return queryRunner.query("select * from t_user where username = ? and password = ?",
                  new BeanHandler<User>(User.class),
                  inputUser.getUsername(),
                  inputUser.getPassword());
      }
      //查询所有
      @Override
      public List<User> selectUserList() throws Exception {
          return queryRunner.query("select * from t_user",
                  new BeanListHandler<User>(User.class));
      }
      //根据id删除
      @Override
      public void deleteById(Integer id) throws Exception {
          queryRunner.update("delete from t_user where id = ?",id);
      }
      //添加用户
      @Override
      public void addUser(User inputUser) throws Exception {
          queryRunner.update("insert into t_user(username,password) values(?,?)",
                  inputUser.getUsername(),
                  inputUser.getPassword());
      }
      //通过id查询用户
      @Override
      public User selectUserById(Integer id) throws Exception {
          return queryRunner.query("select * from t_user where id = ?",
                  new BeanHandler<User>(User.class),
                  id);
      }
      //更改用户
      @Override
      public void updateUser(User user) throws Exception {
          queryRunner.update("update t_user set username = ? ,password = ? where id =?",
                  user.getUsername(),
                  user.getPassword(),
                  user.getId());
      }
      //批量删除用户
      @Override
      public void deleteUsersByIds(List<Integer> idList) {
          for (Integer integer : idList) {
              try {
                  deleteById(integer);
              } catch (Exception e) {
                  e.printStackTrace();
              }
          }
      }
  }
  
  ```

  - LoginServlet

  ```java
  @WebServlet(name = "LoginServlet",urlPatterns = "/login")
  public class LoginServlet extends HttpServlet {
      protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
          //获取参数，并存储到一个User对象中
          String username = request.getParameter("username");
          String password = request.getParameter("password");
          User inputUser = new User();
          inputUser.setUsername(username);
          inputUser.setPassword(password);
          //调用登录方法，看是否有对象返回
          UserDao userDao = new UserDaoImpl();
          try {
              User existUser = userDao.login(inputUser);
              System.out.println(existUser);
              if(existUser != null){
                  //有对象返回，存储登录状态，跳转到展示界面
                  request.getSession().setAttribute("existUser",existUser);
                  response.sendRedirect("/day60/showIndex");
  
              }else {
                  //没有对象返回，跳转回登录界面
                  request.getRequestDispatcher("/login.html").forward(request,response);
              }
          } catch (Exception e) {
              e.printStackTrace();
          }
      }
  
      protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
          doPost(request, response);
      }
  }
  ```

  - LogoutServlet

  ```java
  @WebServlet(name = "LogoutServlet",urlPatterns = "/logout")
  public class LogoutServlet extends HttpServlet {
      protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
          //注销界面,将用户状态移除，并跳转到登录界面
          request.getSession().removeAttribute("existUser");
          request.getRequestDispatcher("/login.html").forward(request,response);
  
      }
  
      protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
          doPost(request, response);
      }
  }
  ```

  

#### 3.2用户列表

> 开发步骤
>
> * 获取用户列表放到首页完成
>   * 登录状态才需要获取用户列表

代码实现

- ShowIndexServlet

```java
@WebServlet(name = "ShowIndexServlet",urlPatterns = "/showIndex")
public class ShowIndexServlet extends HttpServlet {
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
       //展示界面，判断是否在登录状态
        User existUser = (User) request.getSession().getAttribute("existUser");
        StringBuffer responseBody = new StringBuffer();
        if(existUser != null){
            //在登录状态
            responseBody.append("欢迎回来："+existUser.getUsername());
            responseBody.append("   <a href = '/day60/logout'>注销</a><br>");
            responseBody.append("<a href='/day60/add.html'>添加用户</a>");

            //获取用户列表
            UserDao userDao = new UserDaoImpl();

            try {
                List<User> userList = userDao.selectUserList();
                System.out.println(userList);
                //给一个表单
                responseBody.append("<form action='/day60/deleteUsers' method='post'>");
                responseBody.append("<table border='1px' cellspaceing='0px' cellpadding='10px' width='500px' height='50px'>");
                responseBody.append("<tr>");
                responseBody.append("<td></td>");
                responseBody.append("<td>ID</td>");
                responseBody.append("<td>账户</td>");
                responseBody.append("<td>密码</td>");
                responseBody.append("<td>操作</td>");
                responseBody.append("</tr>");
                //遍历集合
                for (User user : userList) {
                    //显示界面不包括自己
                    if(user.getId() != existUser.getId()){
                        responseBody.append("<tr>");
                        responseBody.append("<td><input name = 'ids' type = 'checkbox' value = "+user.getId()+"></td>");
                        responseBody.append("<td>"+user.getId()+"</td>");
                        responseBody.append("<td>"+user.getUsername()+"</td>");
                        responseBody.append("<td>"+user.getPassword()+"</td>");
                        responseBody.append("<td>"+
                                "<a href = '/day60/deleteUser?id="+user.getId()+"'>删除</a>"+
                                "       <a href = '/day60/showUpdateUser?id="+user.getId()+"'>修改</a>");
                        responseBody.append("</tr>");
                    }
                }
                responseBody.append("</table>");
                responseBody.append("<button type='submit'>批量删除</button>");
                responseBody.append("</form>");
            } catch (Exception e) {
                e.printStackTrace();
            }


        }else {
            //不在登录状态
            responseBody.append("您还没有登录，<a href='/day60/login.html'>请登录</a><br>");
        }

        response.setContentType("text/html;charset=utf-8");
        response.getWriter().write(responseBody.toString());
    }

    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doPost(request, response);
    }
}
```



#### 3.3删除用户



> 开发步骤
>
> * 首页，给每一个记录后面添加一个删除按钮（在ShowIndexServlet中）
> * 用户列表不要显示当前登录用户

- 代码实现

  - DeleteUserServlet

  ```java
  @WebServlet(name = "DeleteUserServlet",urlPatterns = "/deleteUser")
  public class DeleteUserServlet extends HttpServlet {
      protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
          //获取选中的id
          String idStr = request.getParameter("id");
          //将id转换为Integer类型
          Integer id = Integer.parseInt(idStr);
          UserDao userDao = new UserDaoImpl();
          //调用userdao中的删除方法
          try {
              userDao.deleteById(id);
          } catch (Exception e) {
              e.printStackTrace();
  
          }
          //返回展示页面
          response.sendRedirect("/day60/showIndex");
      }
  
      protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
          doPost(request, response);
      }
  }
  ```

#### 3.4批量删除

> 开发流程
>
> * 在首页需要给每一个记录新加多选框
> * 当点击批量删除按钮之后，完成批量删除操作

- 代码实现

  - DeleteUsersServlet

  ```java
  @WebServlet(name = "DeleteUsersServlet",urlPatterns = "/deleteUsers")
  public class DeleteUsersServlet extends HttpServlet {
      protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
          //获取一组id值
          String[] ids = request.getParameterValues("ids");
          //如果没有勾选任何多选框，那么ids=null
          if(ids != null){
              List<Integer> idList = new ArrayList<>();
              //遍历数组中的元素
              for (String idStr : ids) {
                  //将id转换为Integer类型
                  Integer id = Integer.parseInt(idStr);
                  //将id存入集合中
                  idList.add(id);
              }
              UserDao userDao = new UserDaoImpl();
              try {
                  //调用UserDao中的批量删除方法
                  userDao.deleteUsersByIds(idList);
              } catch (Exception e) {
                  e.printStackTrace();
              }
          }
          response.sendRedirect("/day60/showIndex");
      }
  
      protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
          doPost(request, response);
      }
  }
  
  ```

#### 3.5添加用户

> 开发步骤
>
> * 首页加入一个添加用户按钮
> * 点击添加用户按钮进入到登录页面

- 代码实现

  - add.html

  ```html
  <!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <title>添加页面</title>
  </head>
  <body>
  <form action="/day60/addUser" method="post">
      账户:<input type="text" name="username"/><br>
      密码:<input type="text" name="password"/><br>
      <button type="submit">添加用户</button>
  </form>
  
  </body>
  </html>
  ```

  - AddUserServlet

  ```java
  @WebServlet(name = "AddUserServlet",urlPatterns = "/addUser")
  public class AddUserServlet extends HttpServlet {
      protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
          String username = request.getParameter("username");
          String password = request.getParameter("password");
          User inputUser = new User();
          inputUser.setUsername(username);
          inputUser.setPassword(password);
  
          UserDao userDao = new UserDaoImpl();
          try {
              userDao.addUser(inputUser);
              //添加成功，跳转回展示页面
              response.sendRedirect("/day60/showIndex");
          } catch (Exception e) {
              e.printStackTrace();
              //添加失败，跳转到用户添加页面
              request.getRequestDispatcher("/add.html").forward(request,response);
          }
  
      }
  
      protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
          doPost(request, response);
      }
  }
  ```

#### 3.6修改用户

> 开发步骤
>
> * 首页加入修改按钮

- 实现代码

  - UpdateUserServlet

  ```java
  @WebServlet(name = "UpdateUserServlet",urlPatterns = "/updateUser")
  public class UpdateUserServlet extends HttpServlet {
      protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
          String idStr = request.getParameter("id");
          Integer id = Integer.parseInt(idStr);
          String username = request.getParameter("username");
          String password = request.getParameter("password");
          //要修改的内容
          User user = new User(id,username,password);
          UserDao userDao = new UserDaoImpl();
          try {
              //调用UserDao中的修改方法
              userDao.updateUser(user);
              //修改成功，跳转到首页
              response.sendRedirect("/day60/showIndex");
          } catch (Exception e) {
              e.printStackTrace();
              //修改失败，跳转到修改页面
              response.sendRedirect("/day60/showUpdateUser?id="+id);
          }
      }
  
      protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
          doPost(request, response);
      }
  }
  
  ```

### 四、BaseServlet

- 前置代码实现

  - c3p0.properties

  ```properties
  c3p0.driverClass=com.mysql.jdbc.Driver
  c3p0.jdbcUrl=jdbc:mysql://localhost:3306/account
  c3p0.user=root
  c3p0.password=1234
  ```

  - JDBCUtil

  ```java
  public class JDBCUtil {
      private static ComboPooledDataSource dataSource;
  
      static {
          dataSource = new ComboPooledDataSource();
      }
      public static ComboPooledDataSource getDataSource(){
          return dataSource;
      }
  }
  
  ```

  - 登录界面

  ```jsp
  <html>
    <head>
      <title>登录</title>
    </head>
    <body>
    <form action="/day61/user" method="get">
      <input type="hidden" name="methodName" value="login">
      账号：<input type="text" name="username"><br>
      密码：<input type="text" name="password"><br>
      <button type="submit">登录</button>
    </form>
    </body>
  </html>
  ```

  - User

  ```java
  public class User {
      private Integer id;
      private String username;
      private String password;
  
      public User() {
      }
  
      @Override
      public String toString() {
          return "User{" +
                  "id=" + id +
                  ", username='" + username + '\'' +
                  ", password='" + password + '\'' +
                  '}';
      }
  
      public Integer getId() {
          return id;
      }
  
      public void setId(Integer id) {
          this.id = id;
      }
  
      public String getUsername() {
          return username;
      }
  
      public void setUsername(String username) {
          this.username = username;
      }
  
      public String getPassword() {
          return password;
      }
  
      public void setPassword(String password) {
          this.password = password;
      }
  
      public User(Integer id, String username, String password) {
          this.id = id;
          this.username = username;
          this.password = password;
      }
  }
  
  ```

  - UserDao
    - 仅登录

  ```
  public interface UserDao {
      User login(User inputUser) throws SQLException;
  }
  ```

  - UserDaoImpl

  ```java
  public class UserDaoImpl implements UserDao {
      QueryRunner queryRunner = new QueryRunner(JDBCUtil.getDataSource());
      //登录
      @Override
      public User login(User inputUser) throws SQLException {
  
              return queryRunner.query("select * from t_user where username = ? and password = ?",
                      new BeanHandler<User>(User.class),
                      inputUser.getUsername(),
                      inputUser.getPassword());
  
      }
  }
  ```

  - UserServlet
    - 配合BaseServlet优化版使用，因为这里的重定向或转发路径通过字符串返回，没有直接重定向或转发

  ```java
  @WebServlet(name = "UserServlet",urlPatterns = "/user")
  public class UserServlet extends BaseServlet {
  
      public String login(HttpServletRequest request,HttpServletResponse response){
          //获取参数
          String username = request.getParameter("username");
          String password = request.getParameter("password");
          User inputUser = new User();
          inputUser.setUsername(username);
          inputUser.setPassword(password);
          UserDao userDao = new UserDaoImpl();
          //调用登录方法
          try {
              User existUser = userDao.login(inputUser);
              if(existUser != null){
                  request.getSession().setAttribute("existUser",existUser);
  
                  //重定向到UserServlet中的showIndex方法中
  
                  return "redirect:/day61/user?methodName=showIndex";
              }else {
                  //转发到index.jsp页面
                  return "forward:/index.jsp";
              }
          } catch (Exception e) {
              e.printStackTrace();
          }
          return "forward:/index.jsp";
      }
  
      public void showIndex(HttpServletRequest request,HttpServletResponse response){
          //判断用户是否在登录状态
          User existUser = (User) request.getSession().getAttribute("existUser");
          StringBuffer stringBuffer = new StringBuffer();
          if(existUser != null){
              //在登录状态
              stringBuffer.append("欢迎回来："+ existUser.getUsername());
              stringBuffer.append("<a href='/day61/user?methodName=logout'>注销登录</a>");
          }else {
              //不在登录状态，回到登录界面
              stringBuffer.append("您还没有登录");
              stringBuffer.append("<a href='/day61/index.jsp'>请登录</a>");
          }
          try {
  
              response.getWriter().write(stringBuffer.toString());
          } catch (IOException e) {
              e.printStackTrace();
          }
      }
      public String logout(HttpServletRequest request,HttpServletResponse response){
          request.getSession().invalidate();
  
              //资源跳转
              return "/index.jsp";
  
      }
  }
  ```

  

#### 4.1BaseServlet的应用

> BaseServlet的作用
>
> * 将浏览器发起的请求分发给指定的子类中的方法执行。

```java
@WebServlet(name = "UserServlet",urlPatterns = "/user")
public class UserServlet extends BaseServlet {



    public void login(HttpServletRequest request,HttpServletResponse response){
        String username = request.getParameter("username");
        String password = request.getParameter("password");
        User inputUser = new User();
        inputUser.setUsername(username);
        inputUser.setPassword(password);
        UserDao userDao = new UserDaoImpl();
        try {
            User existUser = userDao.login(inputUser);
            if (null == existUser) {
                //登录失败
                request.getRequestDispatcher("/login.html").forward(request,response);
            } else {
                //登录成功
                request.getSession().setAttribute("existUser",existUser);
                response.sendRedirect("/day61/user?methodName=showIndex");
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public void showIndex(HttpServletRequest request , HttpServletResponse response) throws Exception {
        System.out.println("showIndex");
        User existUser = (User) request.getSession().getAttribute("existUser");
        StringBuffer responseBody = new StringBuffer();
        if (null != existUser) {
            //在登录状态
            responseBody.append("欢迎回来~~~"+existUser.getUsername());
            responseBody.append("<a href='/day61/user?methodName=logout'>注销登录</a>");
        } else {
            //不在登录状态
            responseBody.append("您还没有登录;");
            responseBody.append("<a href='/day61/login.html'>请登录</a>");
        }
        response.setContentType("text/html;charset=utf-8");
        response.getWriter().write(responseBody.toString());
    }

    public void logout(HttpServletRequest request , HttpServletResponse response) throws Exception {
        request.getSession().invalidate();
        response.sendRedirect("/day61/login.html");
    }


}
```

#### 4.2BaseServlet的优化

> * BaseServlet的作用
>   * 将浏览器发起的请求分发给指定的子类中的方法执行。
>   * 子类Servlet方法的返回值就是跳转的资源的路径
>     * “/资源名称” ：直接转发
>     * "forward:/资源名称"：转发
>     * "redirect:/项目名/资源名称"：重定向
>   * 响应正文中文乱码

```java
@WebServlet(name = "BaseServlet", urlPatterns = "/base")
public class BaseServlet extends HttpServlet {
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        response.setContentType("text/html;charset=utf-8");
        String methodName = request.getParameter("methodName");
        try {
            Method method = this.getClass().getMethod(methodName, HttpServletRequest.class, HttpServletResponse.class);
            if (method != null) {
                String invokeValue = (String) method.invoke(this, request, response);
                //通过String返回值来确定重定向或者跳转
                if (invokeValue != null) {
                    //有返回值，实现资源跳转，需要资源的路径

                    if (invokeValue.lastIndexOf(":") != -1) {
                        //说明包含“：”符号,分为两种情况
                        //将字符串按照“：”符号分隔开
                        String[] split = invokeValue.split(":");
                        String path = split[1];
                        if (invokeValue.startsWith("forward")) {
                            //以forward开头，转发
                            request.getRequestDispatcher(path).forward(request, response);
                        }else if(invokeValue.startsWith("redirect")){
                            //以redirect开头，重定向
                            response.sendRedirect(path);
                        }
                    } else {
                        //不包含“：”符号，默认转发
                        request.getRequestDispatcher(invokeValue).forward(request, response);
                    }


                } else {
                    //没有返回值，不做任何处理
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doPost(request, response);
    }
}
```

